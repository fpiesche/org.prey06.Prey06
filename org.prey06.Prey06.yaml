app-id: org.prey06.Prey06
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '24.08'
command: dhewm3.sh

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc
  - --share=network
  - --socket=pulseaudio

cleanup:
  - /include
  - "*.a"
  - "*.la"
  - /lib/pkgconfig

modules:

  # Upstream request. Sadly no release tags so we'll just use a specific snapshot
  # of the master branch.
  - name: backtrace
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/ianlancetaylor/libbacktrace/archive/7e2b7da3d6568d2e4e78658f22e701746a48d7e1.zip
        sha256: 00e4e08099d7adb57e37dfb165c8256e368cccf8dc70706e90e25327603bec7e

  - name: prey06
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DREPRODUCIBLE_BUILD=ON
    sources:
      - type: archive
        url: https://github.com/dhewm/dhewm3/archive/refs/tags/1.5.4.tar.gz
        sha256: d460d55f7912e220f4d209b66f47e31aad6c2a833af6236a3679096a51f21858
        x-checker-data:
          type: anitya
          project-id: 9154
          url-template: https://github.com/dhewm/dhewm3/archive/refs/tags/$version.tar.gz
      - type: shell
        commands:
          # Install distribution assets first
          - install -Dm 644 dist/linux/share/icons/hicolor/128x128/apps/org.prey06.Prey06.png -t /app/share/icons/hicolor/128x128/apps/
          - install -Dm 644 dist/linux/share/icons/hicolor/256x256/apps/org.prey06.Prey06.png -t /app/share/icons/hicolor/256x256/apps/
          - install -Dm 644 dist/linux/share/icons/hicolor/scalable/apps/org.prey06.Prey06.svg -t /app/share/icons/hicolor/scalable/apps/
          # Main code is one level down
          - mv ./neo/* ./
          # supresses warnings for a non-used directory
          - mkdir -p /app/share/prey06

  - name: launcher
    buildsystem: simple
    sources:
      - type: file
        path: org.prey06.Prey06.desktop
      - type: file
        path: org.prey06.Prey06.metainfo.xml
      - type: script
        commands:
          - ls ~/.var/app/org.prey06.Prey06/data/prey06/base || zenity --error --text
            "Game data /base/ must be added to:\n~/.var/app/org.prey06.Prey06/data/prey06/"
            --ok-label "Close" --width=400
          - prey06 "$@"
        dest-filename: prey06.sh
    build-commands:
      - install -Dm 644 org.prey06.Prey06.desktop -t /app/share/applications
      - install -Dm 644 org.prey06.Prey06.metainfo.xml -t /app/share/metainfo
      - install -Dm 744 prey06.sh -t /app/bin/
